-- 입양일기 테이블
DROP TABLE DIARY CASCADE CONSTRAINTS;
DROP SEQUENCE DNOSEQ;

CREATE SEQUENCE DNOSEQ;
CREATE TABLE DIARY(
    DNO NUMBER PRIMARY KEY, 
    MNO NUMBER NOT NULL, 
    DCONTENT VARCHAR2(2000) NOT NULL,
    DDATE DATE NOT NULL, 
    DIARYIMG VARCHAR2(2000) NOT NULL, 
    DIARYTHUMBIMG VARCHAR2(2000) NOT NULL,

    CONSTRAINT FK_MNO_DIARY FOREIGN KEY(MNO) REFERENCES MEMBER(MNO)
);

INSERT INTO DIARY
VALUES(DNOSEQ.NEXTVAL, 1, '첫번째 입양일기 글 내용입니다', SYSDATE, 'aaa.jpg', 'aaa.jpg');
INSERT INTO DIARY
VALUES(DNOSEQ.NEXTVAL, 1, '두번째 입양일기 글 내용입니다', SYSDATE, 'aaa.jpg', 'aaa.jpg');
INSERT INTO DIARY
VALUES(DNOSEQ.NEXTVAL, 2, '이순신의 입양일기 글 내용입니다~~', SYSDATE, 'aaa.jpg', 'aaa.jpg');

INSERT INTO DIARY
VALUES(DNOSEQ.NEXTVAL, 2, '무한스크롤 테스트용 입양일기 글', SYSDATE, 'aaa.jpg', 'aaa.jpg');

SELECT * 
FROM DIARY;


SELECT *
	FROM (
			SELECT ROW_NUMBER() OVER (ORDER BY DDATE DESC) NUM, DNO, MNO, DCONTENT,
					DDATE, TO_CHAR(DDATE, 'YYYY-MM-DD HH24:MI') AS ddateToChar, MNICK, DIARYIMG, DIARYTHUMBIMG
			FROM DIARY A JOIN MEMBER USING(MNO)
			ORDER BY DDATE DESC
	)
	WHERE NUM BETWEEN 1 AND 3
	ORDER BY NUM

	SELECT DNO, MNO, DCONTENT,DDATE, TO_CHAR(DDATE, 'YYYY-MM-DD HH24:MI') AS ddateToChar, MNICK, DIARYIMG, DIARYTHUMBIMG
		FROM DIARY JOIN MEMBER USING(MNO)
		ORDER BY DDATE DESC

-- 댓글, 대댓글 구현 관련
DROP TABLE DIARYREPLY CASCADE CONSTRAINTS;
DROP SEQUENCE DRNOSEQ;
DROP SEQUENCE DRGROUPNOSEQ;

CREATE SEQUENCE DRNOSEQ;
CREATE SEQUENCE DRGROUPNOSEQ;
CREATE TABLE DIARYREPLY(
    DRNO NUMBER PRIMARY KEY, 
    DNO NUMBER NOT NULL, 
    DRGROUPNO NUMBER NOT NULL,
    DRTITLETAB NUMBER NOT NULL, 
    DRGROUPSQ NUMBER NOT NULL, 
    MNO NUMBER NOT NULL, 
    DRCONTENT VARCHAR2(2000) NOT NULL, 
    DRDATE DATE NOT NULL, 
    
    CONSTRAINT FK_DNO_DIARYREPLY FOREIGN KEY(DNO) REFERENCES DIARY(DNO) ON DELETE CASCADE, 
    CONSTRAINT FK_MNO_DIARYREPLY FOREIGN KEY(MNO) REFERENCES MEMBER(MNO)
);

INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 42, DRGROUPNOSEQ.NEXTVAL, 0, 0, 1, '댓글예시1', SYSDATE);
INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 42, DRGROUPNOSEQ.NEXTVAL, 0, 0, 1, '댓글예시2', SYSDATE);
INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 41, DRGROUPNOSEQ.NEXTVAL, 0, 0, 2, '댓글예시3', SYSDATE);
INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 42, 1, 1, 1, 2, '댓글의 답글 예시1', SYSDATE);
INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 42, 2, 1, 1, 2, '댓글의 답글 예시2', SYSDATE);
INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 42, 2, 1, 2, 2, '댓글의 답글 예시3', SYSDATE);

INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 39, DRGROUPNOSEQ.NEXTVAL, 0, 0, 1, '댓글예시 39번글', SYSDATE);
INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 39, DRGROUPNOSEQ.NEXTVAL, 0, 0, 1, '댓글예시 39번글', SYSDATE);
INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 38, DRGROUPNOSEQ.NEXTVAL, 0, 0, 1, '댓글예시 38번글', SYSDATE);
INSERT INTO DIARYREPLY
VALUES(DRNOSEQ.NEXTVAL, 37, DRGROUPNOSEQ.NEXTVAL, 0, 0, 1, '댓글예시 37번글', SYSDATE);

SELECT * 
FROM DIARYREPLY;

--마이다이어리 글 삭제 시 해당 댓글 함께 삭제되는 제약 조건 수정 및 추가
ALTER TABLE DIARYREPLY DROP CONSTRAINT FK_DNO_DIARYREPLY;

ALTER TABLE DIARYREPLY ADD CONSTRAINT FK_DNO_DIARYREPLY FOREIGN KEY(DNO) 
REFERENCES DIARY(DNO) ON DELETE CASCADE;

-- 좋아요 테이블
DROP TABLE LIKETABLE;
DROP SEQUENCE LIKENOSEQ;
DROP TABLE LIKETABLE;

CREATE SEQUENCE LIKENOSEQ;
CREATE TABLE LIKETABLE(
    LIKENO NUMBER PRIMARY KEY, 
    DNO NUMBER NOT NULL, 
    MNO NUMBER NOT NULL, 
    LIKEYN VARCHAR2(10) NOT NULL, 

    CONSTRAINT FK_MNO_LIKE FOREIGN KEY(MNO) REFERENCES MEMBER(MNO), 
    CONSTRAINT FK_DNO_LIKE FOREIGN KEY(DNO) REFERENCES DIARY(DNO),
    CONSTRAINT LIKEYN_CHK CHECK(LIKEYN IN('Y','N'))

);

INSERT INTO LIKETABLE
VALUES(LIKENOSEQ.NEXTVAL, 1, 2, 'Y');

SELECT *
FROM LIKETABLE;
commit


INSERT INTO DIARYREPLY VALUES(
DRNOSEQ.NEXTVAL, 14, DRGROUPNOSEQ.NEXTVAL, 0, 0, 2, '첫 번째 댓글', SYSDATE
);

INSERT INTO DIARYREPLY VALUES(
DRNOSEQ.NEXTVAL, 14, DRGROUPNOSEQ.NEXTVAL, 0, 0, 1, '두 번째 댓글', SYSDATE
);

SELECT * FROM DIARYREPLY;

INSERT INTO DIARYREPLY VALUES(
DRNOSEQ.NEXTVAL, 14, 21, 1, 1, 2, '두 번째 글 첫 번째 댓글의 답글', SYSDATE
)

INSERT INTO DIARYREPLY VALUES(
DRNOSEQ.NEXTVAL, 14, 22, 1, 1, 1, '두 번째 글 두 번째 댓글의 답글', SYSDATE
)

